
# JVM 类加载机制

> Create Time : 2017年8月3日  Ref : 深入理解Java虚拟机 （周志明）

类从被加载到虚拟机内存中开始，到卸载出内存为止，整个生命周期包括：加载，验证，准备，解析，初始化，使用，和卸载 7个阶段。

## 加载

`加载`是`类加载`的一个阶段。

1. 通过一个类的全程限定名来获取此类的二进制字节流。
2. 将这个字节流所代表的静态存储结构转换为方法区的运行时数据结构。
3. 在内存中生成一个代表这个类的Class对象，作为方法区这个类的个种数据的访问入口。

数组由JVM直接创建，而不是类加载器创建。

## 验证

### 文件格式验证

1. 是否以魔数0xCAFEBABE开头
2. 主次版本号是否在当前虚拟机处理范围之内。
3. 常量池中的常量是否有不被支持的常量类型
4. 指向常量的各种索引值中是否有只想不存在的常量或不符合类型的常量。
5. CONSTANT_Utf8_info型常量中是否有不符合UTF8编码的数据。
6. Class文件中各个部分及文件本身是否有被删除的或附加的其他信息。


### 元数据验证

1. 这个类是否有父类（除了Object外，其他的类都应该有父类）
2. 这个类是否集成了不允许被继承的类（final类）
3. 如果这个类不是抽象类，是否实现了其父类或接口中要求实现的所有方法
4. 类中的字段、方法是否与父类产生矛盾（如覆盖了final字段，或者不正确的方法重载）


### 字节码验证

1. 保证任何时候操作数栈的数据类型与指令代码序列都能配合工作，例如不会出现类似这样的情况： 在操作数栈放置了一个int类型的数据，使用时却按照long类型来加载本地变量表中。
2. 保证跳转指令不会跳转到方法体以外的字节码指令上。
3. 保证方法体中的类型转换是有效的

### 符号引用验证

1. 符号引用中通过字符串描述的全称限定名是否能找到对应的类。
2. 在指定的类中是否存在符合方法的字段描述符以及简单名称所描述的方法和字段。
3. 符号引用中的类、字段、方法的访问性（private public）是否可被当前类访问。

## 准备

准备阶段是正式为类变量分配内存并设置初始值的阶段，这些变量所使用的内存都将在方法区中进行分配。

准备为0值，而不是初始化赋的值。只准备类变量的值，实例变量将会在对象实例化时一同分配在对象。

## 解析

* 符号引用
* 直接引用

1. 类或者接口解析
2. 字段解析
3. 类方法解析
4. 接口方法解析

## 初始化

<cinit>

<init>

## 使用

## 卸载


