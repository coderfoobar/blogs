
***【A00301】支付账户交易明细查询 :***
> 公安部门给出对应支付账号，业务组获取参数后调去在公安指定时间内的成功交易明细，上传笔数小于等于1000
---
`FetchTask` : 

1. 从前置机获取指令报文列表，遍历，除重，将新的指令存入`接收指令表`与`待执行表`。

---
`QueryTask` : 

2. 从`待执行表`中取出所有待执行的指令，循环遍历，判断警官证等是否附在报文中（Attachments下节点个数），如果证照齐全，执行`步骤3`；否则，按`相应法律文书缺失`处理，反馈`0600或0699`。

3. 判断指令处理机构是否是融宝（即`OnlinePayCompanyID=='Z10712000017'`）*并且指令发送机构是否在`字典表`中*，如果为`是`，执行`第4步`；否则，否则组装反馈报文，反馈`0700` 。

4. 过滤出`A00301`，`if( DataType == 01 )`,执行步骤5 。

5. 调用业务组接口，查询该`账户(Data  支付账号 )`是否`已注销`，如果为`是`，反馈`2200`,否则，执行`步骤6` 。出现异常，执行`步骤7` 。

6. 调用业务组接口，查询`账户(Data  支付账号 )`在给定的`交易起止时间(StartTime ExpireTime)`内的所有交易明细，如果笔数大于`1000`笔，分多次发送反馈报文`（do while(list > 1000)） ?`。成功，执行`步骤8`；出现异常，执行`步骤7` 。

7. 如果在`第5、6步`中调用业务组接口出现错误，直接反馈`2299`，同时在`异常表`中加入该条指令记录及异常信息。执行`步骤9` 。

8. `第6步`中每次反馈的`response`均为成功，则更新`指令接收表`中的状态，并在`指令日志表`中记录该条指令及状态，删除`待执行表`中的该条记录，否则，存入`异常表`，并删除`待执行表`中的该条记录。

9. 结束。
---

***【A00303】账户主体详情查询 :***
> 业务组获取某一支付账号号码后，查询对应在融宝的相关主体信息。
---
`FetchTask` : 

1. 从前置机获取指令报文列表，遍历，除重，将新的指令存入`接收指令表`与`待执行表`。

---
`QueryTask` : 

2. 从`待执行表`中取出所有待执行的指令，循环遍历，判断警官证等是否附在报文中（Attachments下节点个数），如果证照齐全，执行`步骤3`；否则，按`相应法律文书缺失`处理，反馈`0600或0699`。

3. 判断指令处理机构是否是融宝（即`OnlinePayCompanyID=='Z10712000017'`）*并且指令发送机构是否在`字典表`中*，如果为`是`，执行`第4步`；否则，否则组装反馈报文，反馈`0700` 。

4. 过滤出`A00303`，`if( DataType == 01 )`,执行`步骤5` 。

5. 调用业务组接口，查询该`账户(Data  支付账号 )`是否`已注销`，如果为`是`，反馈`2200`,否则，执行`步骤6` 。出现异常，执行`步骤7` 。

6. 调用业务组接口，查询`账户(Data  支付账号 )`对应在融宝的相关主体信息。成功，执行`步骤8`；出现异常，执行`步骤7` 。

7. 如果在`第5、6步`中调用业务组接口出现错误，直接反馈`2299`，同时在`异常表`中加入该条指令记录及异常信息。执行`步骤9` 。

8. `第6步`中反馈的`response`均为成功，则更新`指令接收表`中的状态，并在`指令日志表`中记录该条指令及状态，删除`待执行表`中的该条记录，否则，存入`异常表`，并删除`待执行表`中的该条记录。

9. 结束。

---

***【A00305】账户动态查询*** :
> 公安部门制定一个支付账号，业务组获取后，在公安部门指定的时间内，t+1反馈改账号的成功交易记录，超过1000笔，需要分包上报
---
`FetchTask` : 

1. 从前置机获取指令报文列表，遍历，除重，将新的指令存入`接收指令表`与`待执行表`。

---
`QueryTask` : 

2. 从`待执行表`中取出所有待执行的指令，循环遍历，判断警官证等是否附在报文中（Attachments下节点个数），如果证照齐全，执行`步骤3`；否则，按`相应法律文书缺失`处理，反馈`0600或0699`。

3. 判断指令处理机构是否是融宝（即`OnlinePayCompanyID=='Z10712000017'`）*并且指令发送机构是否在`字典表`中*，如果为`是`，执行`第4步`；否则，否则组装反馈报文，反馈`0700` 。

4. 过滤出`A00305`，`if( DataType == 01 )`,执行`步骤5` 。

5. 对比报文中的`起止日期`与`当前日期`以及该记录中的`修改时间`，如果`当前时间`是在`起止日期`内，执行`步骤6`；否则，执行`步骤7`；

6. 如果`当前日期 - 修改日期 > 1天`， 则执行`步骤8`；否则，执行`步骤9` 。（本步骤中要确定插入待执行表记录时，一定要初始化好修改时间）

7. 解除动态查询： 更新`指令接收表`中该条指令的状态为`自动解除`，删除`待执行表`中本条记录，在`指令日志表`中记录相关操作。执行`步骤9` 。

8. 调用业务组接口： 传入`AccountNumber`支付账号以及`昨天的时间界限`，调用业务组接口，查询昨天该账户的所有交易，如果交易数大于1000，分多次反馈。最后一次反馈更新该记录`修改时间`为`当前时间`(保证动态查询时间为凌晨，且每天执行一次)。

9. 结束

---

***【A00307】账户动态查询解除*** :
> 收到公安部门的解除指令后对某一个支付账号解除动态查询
---
`FetchTask` : 

1. 从前置机获取指令报文列表，遍历，除重，将新的指令存入`接收指令表`与`待执行表`。

---
`QueryTask` : 

2. 从`待执行表`中取出所有待执行的指令，循环遍历，判断警官证等是否附在报文中（Attachments下节点个数），如果证照齐全，执行`步骤3`；否则，按`相应法律文书缺失`处理，反馈`0600或0699`。

3. 判断指令处理机构是否是融宝（即`OnlinePayCompanyID=='Z10712000017'`）并且指令发送机构是否在`字典表`中，如果为`是`，过滤出`A00307`，执行`步骤4`，否则组装反馈报文，反馈`0700` 。

4. 根据`OriginalApplicationID` 原动态查询申请编号查询`指令接受表`，比较申请时间和原记录中的过期时间，如果申请时间大于过期时间，则无论如何执行下删除待执行表中的记录，之后反馈`2300`；
否则，删除待执行表中的记录，并反馈`0000`。如果在上述过程中发生异常，则反馈`2399` 。执行`步骤5` 。

5. 结束。

---

***【A00309】关联全支付账号查询*** :
> 业务组收到证件号，手机号，银行卡号，登录号，其中一个之后，将其关在融宝的账号信息返回
---
`FetchTask` : 

1. 从前置机获取指令报文列表，遍历，除重，将新的指令存入`接收指令表`与`待执行表`。

---
`QueryTask` : 

2. 从`待执行表`中取出所有待执行的指令，循环遍历，判断警官证等是否附在报文中（Attachments下节点个数），如果证照齐全，执行`步骤3`；否则，按`相应法律文书缺失`处理，反馈`0600或0699`。

3. 判断指令处理机构是否是融宝（即`OnlinePayCompanyID=='Z10712000017'`）并且指令发送机构是否在`字典表`中，如果为`是`，过滤出`A00309`，执行`步骤4`，否则组装反馈报文，反馈`0700` 。

4. 调用业务组接口：根据 `证件号，手机号，银行卡号，登录号` 等条件调用业务组接口，查出关联的全支付账号。执行`步骤5`。

5. 组装报文，反馈结果。如果`response`是成功，则将该指令添加到`指令日志表`中，并将该指令从`待执行表`中删除。否则，添加到`异常表`中,并将该指令从`待执行表`中删除。执行`步骤6` 。

6. 结束。

---

***【A00311】按照银行外部交易流水号／支付订单号查询银行卡/支付帐号*** :
> 业务组获取参数后，查询到对应的交易信息，并将这些信心返回
---
`FetchTask` : 

1. 从前置机获取指令报文列表，遍历，除重，将新的指令存入`接收指令表`与`待执行表`。

---
`QueryTask` : 

2. 从`待执行表`中取出所有待执行的指令，循环遍历，判断警官证等是否附在报文中（Attachments下节点个数），如果证照齐全，执行`步骤3`；否则，按`相应法律文书缺失`处理，反馈`0600或0699`。

3. 判断指令处理机构是否是融宝（即`OnlinePayCompanyID=='Z10712000017'`）并且指令发送机构是否在`字典表`中，如果为`是`，过滤出`A00311`，执行`步骤4`，否则组装反馈报文，反馈`0700` 。

4.  调用业务组接口：根据`交易流水号`或者`支付订单号`，调用业务组接口，查询银行卡/支付账号。执行`步骤5` 。

5. 组装报文，反馈结果。如果`response`是成功，则将该指令添加到`指令日志表`中，并将该指令从`待执行表`中删除。否则，添加到`异常表`中,并将该指令从`待执行表`中删除。执行`步骤6` 。

6. 结束。





































