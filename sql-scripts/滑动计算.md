
# 滑动计算

> Create Time : 2017年3月16日 Author : huduku.io Ref : 


## 滑动计算场景简化

> 数据库环境是`MySQL`

** 因为原问题场景比较复杂，下面将其简化描述：`(标题描述可能不太切题)`**

现在有两张表`t1`和`t2`，表结构相同，但是存储的数据不同。`主键a`与`字段b`类型均为`int`型。示例如下。

其中，表`t1`和表`t2`存在部分`主键a`相同，但是`字段b`值不同的数据。也有`主键值`在表`t1`中存在，但是表`t2`中不存在，或者`主键值`在表`t2`中存在，但是表`t1`中不存在。


* 表 t1 : 

| a | b |
| :--- | :---|
| 1 | 10 |
| 2 | 5  |
| 3 | 7  |
| 4 | 7  |
| 5 | 7  |

* 表 t2 : 

| a | b |
| :--- | :---|
| 3 | 17 |
| 4 | 8  |
| 5 | 3  |
| 6 | 11 |
| 7 | 6  |

现在，按主键值相同的情况下进行计算，`t1.b - t2.b`。如果`主键a`的值在对方表中不存在，则`字段b`取`0`值。查询得到如下表结构的数据。

| a | t1.b - t2.b |
| :--- | :---|
| 1 | 10 |
| 2 | 5  |
| 3 | -10|
| 4 | -1 |
| 5 | 4  |
| 6 | -11|
| 7 | -6  |

我所想到的`sql`语句如下：
```sql
SELECT t1.a, t1.b - t2.b from t1 left  join t2 on t1.a = t2.a
union
SELECT t2.a, t1.b - t2.b from t1 right join t2 on t1.a = t2.a;
```

但是，这条`sql`不能解决两个问题：
* **如果`主键a`的值在对方表中不存在，则`字段b`取`0`值。**
* **两次`join`会导致主键值为3,4,5的数据重复计算**

**怎么写sql比较好？**

---

下面的sql可以解决上面的转0问题，但是仍然解决不了重复计算的问题。
```sql
SELECT t1.a, ifnull(t1.b, 0) - ifnull(t2.b, 0) from t1 left  join t2 on t1.a = t2.a
union
SELECT t2.a, ifnull(t1.b, 0) - ifnull(t2.b, 0) from t1 right join t2 on t1.a = t2.a;
```

---

```sql
select fa,fb from(
  SELECT t1.a as fa , ifnull(t1.b, 0) - ifnull(t2.b, 0) as fb from t1 left  join t2 on t1.a = t2.a
	union
	SELECT t2.a as fa,0-t2.b  as fb from t2 where t2.a not in (select t1.a from t1 )
) t order by t.fa

```

---

## 滑动计算场景模拟

* 表 t3 : 

| a | b | c |
| :--- | :---| :--- |
| 1 | 10 | 1 |
|2 |	5 |	2 |
|3 |	7 |	3 |
|4 |	7 |	4 |
|5 |	7 |	5 |
|3 |	17 |	6 |
|4 |	8 |	7 |
|5 |	3 |	8 |
|6 |	11 |	9 |
|7 |	6 |	10 |


```
select t.a , sum(t.b) from (
	select t3.a , b from t3 where c <=5
	union all
	select t3.a , 0-b from t3 where c > 5
) t group by t.a
```